This is the full link to the ticket. Use this to get access to any attached screenshots.
https://eliterate.atlassian.net/browse/MER-5257

## Ticket Description
User Story As an  instructor , I want  AI-generated emails to be aware of the context from which I initiate the email , so that the draft content is relevant to the students, activity, and situation I’m responding to (e.g., struggling students, incomplete assessments). Acceptance Criteria Positive Acceptance Criteria Context-Aware Entry Points Given  an instructor selects  Email  from a supported location, including but not limited to: Student Support tile Assessments tile Student Overview Content → Student list Learning Objectives → Student list Any other supported location where emailing students is applicable Then  the system captures the  initiation context , including (when available): Student subset or status (e.g., struggling, incomplete, excelling…) Relevant content or assessment name Course name Instructor name Any applicable deadlines or performance signals Email Modal — General Then  the email modal: Is updated to match the  Figma styling Is titled  “Draft Email” Recipients (To:) Given  the Draft Email modal is open Then : Recipients are auto-filled  based on the selected students Recipients are displayed as  chips Chips are  truncated  if they exceed the input width And : Clicking the  “X”  on a chip removes that student from the recipient list The instructor can click into the field to  add additional email recipients manually Subject (AI-Generated) Then : The  Subject  line is  auto-generated by AI , based on the current context (e.g., page, activity, student selection) The subject field is  editable by the instructor AI Draft Generation (Context-Aware) Then  the AI-generated  Subject  and  Body : Explicitly reflect the  context from which Email was initiated Example: incomplete assessment, struggling students… Use language appropriate to the identified student group Avoid generic phrasing when contextual information is available And : Subject is  auto-generated  and editable Body is  auto-generated , editable, and contextually relevant Placeholder fields using square brackets (e.g.,  {course_name} ,  {first_name} ,  {instructor_name} ) are  automatically populated  when possible The body input  scrolls vertically  once content exceeds the visible height Instructors can  insert and edit hyperlinks Draft Controls Given  the instructor clicks  “Generate new draft” Then : A new AI-generated subject and body replace the existing draft The selected tone (if any) is applied to the new draft Tone Selection Then  the modal includes tone selection buttons: Neutral Encouraging Firm And : Selecting a tone does  not  immediately regenerate content The selected tone is applied  only when “Generate new draft” is clicked Default tone will be neutral Footer Guidance Then  the modal displays the following footnote: “Fields contained in square brackets like {first_name} will be personalized automatically.” Sending Email When  the instructor selects  Send Then : The email is sent to all listed recipients using the existing Torus email delivery mechanism A confirmation banner stating  “Email sent”  is displayed in the dashboard Negative Acceptance Criteria Do not  send emails automatically without explicit instructor action Do not  regenerate content unless  “Generate new draft”  is explicitly clicked Do not  allow sending if: No recipients are present Required email fields are invalid Do not  expose raw AI placeholders (e.g.,  {first_name} ) in sent emails when data is available Do not  navigate away from the instructor’s current context when opening or closing the email modal Design Notes   Accessibility Guidance Operable (Keyboard) When the modal opens, keyboard focus moves to a logical starting point (typically the  To  field) and is not lost. Focus is  trapped within the modal  while it is open. The modal can be closed using  Escape , and focus returns to the UI element that launched it. All interactive elements are reachable and usable via keyboard-only navigation: Tab / Shift+Tab move through elements in a logical order Enter/Space activate buttons and controls Users can navigate into the chip list using keyboard. Each chip is focusable and includes an accessible label (e.g., “Recipient: Alex Kim, remove”). Removing recipients is possible without a mouse: The remove control (“X”) is focusable and activatable via Enter/Space,  or Backspace/Delete removes the currently focused chip (with an announced confirmation). After a chip is removed, focus moves to a logical next element: Next chip if available, otherwise previous chip, otherwise the To input. Robust (Screen Reader / Semantics) The modal uses proper dialog semantics (e.g.,  role="dialog"  or  role="alertdialog" ) and is correctly labeled by the modal title. Controls have correct accessible names and roles: Buttons are buttons Inputs are inputs Tone buttons expose pressed/selected state (e.g.,  aria-pressed  or radio semantics) Dynamic updates are announced appropriately: When recipients are added/removed, screen readers are informed (e.g., via polite live region or immediate announcement on action). When validation errors appear, they are announced and linked to fields. Truncation and overflow Truncation does not hide information from assistive tech: Screen readers can access the full email/name even if visually truncated. If chips overflow into a “+N more” pattern, it is keyboard and screen-reader accessible: “+N more” can be expanded/collapsed via keyboard Expanded content remains within the modal’s focus trap Technical Notes Testing Notes

## Technical Guidance Notes (Darren Siegel Jira comments)
This is a FEATURE, slug is email_sending Proposed technical guidance for implementation 1) Scope split: non-UI domain services vs UI modal - Implement this as two coordinated layers: - Non-UI instructor-dashboard-specific domain services for context building, prompt construction, AI draft generation, and template realization. - Reusable UI modal for instructor interaction (recipients, tone, draft editing, regenerate, send). - Keep this logic in instructor-dashboard code, not in global generic GenAI helpers, except for thin reuse of the existing completion client. 2) Non-UI component A: AI draft generation facade (thin over existing completions) - Add a small service that: - Accepts a strongly typed email generation context + tone + prompt template inputs. - Builds one composed prompt. - Calls existing synchronous completion generation. - Returns structured output:  subject_template ,  body_template . - Responsibility boundary: this service generates draft templates only; it does not send email. 3) Non-UI component B: context builder (shared entry-point infrastructure) - Add a reusable context-builder service invoked by all dashboard entry points that can open Email. - Context builder performs required DB reads and returns normalized context: -  section/course/instructor  info - recipient students (ids, names, emails, any needed personalization fields) - entry-point situation data (see section 4) - optional content/assessment metadata and performance/deadline signals - default tone ( neutral ) - Goal: isolate DB/query logic from UI tiles and ensure consistent context shape across Student Support, Assessments, Student Overview, Content student list, LO student list, etc. 4) Situation contract (critical for contextual quality) - Define a stable  situation  contract as the trigger context for prompt composition. - Recommended pattern: - Use enumerated situation keys (e.g.,  :incomplete_assessment ,  :struggling_students , etc.). - Maintain a lookup map from key -> canonical human-readable situation description used in prompt assembly. - This keeps callers simple and enforceable while centralizing prompt semantics. 5) Prompt composer rules - Implement explicit prompt assembly logic in the domain service, not ad hoc in UI. - Prompt should include: - role/task framing (instructor drafting outreach email) - resolved situation description - tone directive (neutral/encouraging/firm) - available personalization variables and formatting constraints - instruction to generate a reusable template for one student instance - Output should intentionally include placeholders for runtime substitution. 6) Reusable Draft Email modal (UI) - Create a reusable modal component scoped to instructor dashboard and callable from multiple tiles/pages. - Behavior contract: - On open: load context + generate initial subject/body draft using default tone ( neutral ). - Tone selection updates selected tone state only. - Regeneration occurs only when  Generate new draft  is clicked (apply selected tone there). - Subject/body remain editable before send. - Keep accessibility requirements in ticket as first-class (focus trap, keyboard chip operations, dialog semantics, aria states/announcements). 7) Send pipeline: template realization + job enqueue - On  Send , perform deterministic template realization per recipient: - Input: edited subject/body template + recipient/instructor/course values. - Output: concrete per-recipient subject/body strings. - Then enqueue one existing email delivery Oban job per resolved recipient. - Show success banner ( Email sent ) after successful enqueue/dispatch path per existing mechanism. 8) Placeholder substitution strategy - Supported tokens are curly-brace placeholders (e.g.,  {first_name },  {student_name },  {instructor_name },  {course_name }). - Implement a dedicated substitution module with whitelist-based token replacement. - Recommended approach: direct token replacement from a known map (safe/deterministic). - If EEx is used internally, normalize placeholders first and strictly whitelist allowed bindings; do not evaluate arbitrary user-provided expressions. - Guarantee that known placeholders are resolved when data is available and raw tokens are not leaked in sent emails when resolvable. 9) Data model and validation expectations - Recipients: - Start from context-selected students, allow manual additions/removals in UI. - Validate non-empty recipient set and valid required email fields before enabling send. - Regeneration: - Preserve current recipient edits and tone selection across regenerations. - Errors: - Draft-generation failure: keep modal open, surface recoverable error, allow retry. - Send/enqueue failure: no silent partial success; return actionable feedback. 10) Suggested acceptance criteria addendum - “A shared non-UI context builder service provides a normalized email generation context for all supported entry points.” - “AI draft generation is implemented via an instructor-dashboard domain service that composes prompts and calls the existing completion generator.” - “Tone changes do not regenerate content until  Generate new draft  is explicitly selected.” - “On Send, templates are realized per recipient via placeholder substitution and dispatched via existing Torus email delivery jobs (one job per recipient).” - “Context situation is represented by a stable contract (enum key + canonical description lookup) to ensure consistent prompt behavior across entry points.”
